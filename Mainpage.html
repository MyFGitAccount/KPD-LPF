<script type="module">
import API from './api.js';

document.addEventListener('DOMContentLoaded', () => {
  let coursesDatabase = {};

  async function loadCoursesDatabase() {
    try {
      const res = await API.getCourses();
      coursesDatabase = res.data || {};
      console.log('Courses loaded:', Object.keys(coursesDatabase));
    } catch (e) {
      console.error('Failed to load courses', e);
      coursesDatabase = {};
    }
  }
  loadCoursesDatabase();

  function showMessage(msg, type){
    const el = document.getElementById('validationMessage');
    el.textContent = msg;
    el.className = 'validation-message ' + type;
  }

  function validateCourseCode(code){
    return coursesDatabase[code.toUpperCase().trim()] || null;
  }

  document.getElementById('courseForm').addEventListener('submit', async e => {
    e.preventDefault();
    const sid = document.getElementById('student_id').value.trim();
    const pwd = document.getElementById('password').value;
    const code = document.getElementById('course_id').value.trim().toUpperCase();

    const auth = await API.login({ sid, password: pwd });
    if (!auth.ok) return showMessage('Login failed: ' + (auth.error || ''), 'error');
    if (auth.role === 'admin'){
      location.href = `admin.html?sid=${sid}&pwd=${pwd}&code=${code}`;
      return;
    }

    const title = validateCourseCode(code);
    if (title){
      showMessage('Valid! Loading...', 'success');
      const target = code === 'EIS' ? 'eis-viewer.html' : `course-viewer.html?code=${encodeURIComponent(code)}`;
      setTimeout(() => location.href = target, 800);
    } else {
      showMessage('Course does not exist.', 'error');
      document.getElementById('addCourseBtn').style.display = 'flex';
    }
  });

  document.getElementById('course_id').addEventListener('input', function(){
    const code = this.value.trim().toUpperCase();
    const msg = document.getElementById('validationMessage');
    const addBtn = document.getElementById('addCourseBtn');
    if (!code){ msg.textContent=''; addBtn.style.display='none'; return; }
    const title = validateCourseCode(code);
    if (title){ showMessage(`${title}`, 'success'); addBtn.style.display='none'; }
    else if (code.length>=3){ showMessage('Course not found.', 'error'); addBtn.style.display='flex'; }
    else addBtn.style.display='none';
  });

  const qs = new URLSearchParams(location.search);
  const sid = qs.get('sid'), pwd = qs.get('pwd');
  if(sid) document.getElementById('student_id').value = sid;
  if(pwd) document.getElementById('password').value = pwd;

  window.redirectToEditor = function(){
    const code = document.getElementById('course_id').value.trim().toUpperCase();
    location.href = code ? `course-editor.html?code=${encodeURIComponent(code)}` : 'course-editor.html';
  };
});
</script>
