<script type="module">
import API from './api.js';
import DB from './db.js';

function showSection(which){
  document.getElementById('accountsSection').classList.toggle('hidden', which !== 'accounts');
  document.getElementById('coursesSection').classList.toggle('hidden', which !== 'courses');
}

async function renderAccounts(){
  const list = document.getElementById('accountsList');
  list.innerHTML = '';
  const pending = await API.getPendingAccounts().then(r => r.data);
  if (!pending.length){ list.innerHTML = '<div class="pill">No pending account requests</div>'; return; }
  pending.forEach(req => {
    const div = document.createElement('div');
    div.className = 'block';
    div.innerHTML = `
      <div class="block-header" style="gap:12px;">
        <div style="display:flex; align-items:center; gap:12px;">
          <img src="${req.photoBase64 || ''}" alt="photo" style="width:64px;height:64px;object-fit:cover;border-radius:8px;border:1px solid rgba(59,130,246,0.3);background:rgba(15,23,42,0.4);" onerror="this.style.display='none'">
          <strong>Student ID: ${req.sid}</strong>
        </div>
        <span class="pill">Pending</span>
      </div>
      <div class="actions">
        <button class="submit-btn" onclick="approveAccount('${req.sid}')">Approve</button>
        <button class="cancel-btn submit-btn" onclick="rejectAccount('${req.sid}')">Reject</button>
      </div>`;
    list.appendChild(div);
  });
}

window.approveAccount = async sid => {
  await API.approveAccount(sid);
  renderAccounts();
};
window.rejectAccount = async sid => {
  await API.rejectAccount(sid);
  renderAccounts();
};

async function renderCourses(){
  const list = document.getElementById('coursesList');
  list.innerHTML = '';
  const pending = await API.getPendingCourses().then(r => r.data);
  if (!pending.length){ list.innerHTML = '<div class="pill">No pending course requests</div>'; return; }
  pending.forEach(req => {
    const div = document.createElement('div');
    div.className = 'block';
    div.innerHTML = `
      <div class="block-header"><strong>${req.code} - ${req.title}</strong><span class="pill">Pending</span></div>
      <div class="actions">
        <button class="submit-btn" onclick="approveCourse('${req.code}')">Approve</button>
        <button class="cancel-btn submit-btn" onclick="rejectCourse('${req.code}')">Reject</button>
      </div>`;
    list.appendChild(div);
  });
}
window.approveCourse = async code => { await API.approveCourse(code); renderCourses(); };
window.rejectCourse = async code => { await API.rejectCourse(code); renderCourses(); };

window.normalLogin = () => location.href = 'Mainpage.html';

// init
showSection('accounts');
renderAccounts();
renderCourses();
</script>
